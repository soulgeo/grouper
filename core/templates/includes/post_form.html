{% load static %}
{% load widget_tweaks %}

{% with modal_id=modal_id|default:"post_modal" %}

{% if not hide_trigger %}
<div class="flex flex-row gap-4 p-4 bg-base-200 rounded-lg drop-shadow-sm cursor-pointer hover:bg-base-300 transition-colors duration-200" 
     hx-get="{% url 'get_create_post' %}" 
     hx-target="#global_modal_container" 
     hx-swap="innerHTML">
    <a href="/p/{{ user.username }}" class="btn btn-ghost btn-circle avatar flex-none" onclick="event.stopPropagation()">
        <div class="w-10 rounded-full overflow-hidden">
            <img class="w-full h-full object-cover" src="{{ user.profile.image_url }}" alt="{{ user.username }}">
        </div>
    </a>
    <div class="flex items-center w-full">
        <div class="w-full h-10 px-4 rounded-full bg-base-100 flex items-center text-base-content/60 border border-base-content/10">
            Share something...
        </div>
    </div>
</div>
{% endif %}

<dialog id="{{ modal_id }}" class="modal">
    <div class="modal-box w-11/12 max-w-5xl">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 focus:outline-none">âœ•</button>
        </form>
        <h3 class="font-bold text-lg mb-4 text-center">{{ form_title|default:"Create Post" }}</h3>

        <div id="{{ modal_id }}_errors">
            {% if form_errors %}
                <div class="alert alert-error py-2 px-4 mb-4 text-sm rounded-lg">
                    <ul class="list-none p-0 m-0">
                        {% for field, errors in form_errors.items %}
                            {% for error in errors %}
                                <li>{% if field != '__all__' %}<span class="font-bold">{{ field }}:</span> {% endif %}{{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        </div>

        <div class="flex flex-row gap-4">
            <div class="btn btn-ghost btn-circle avatar flex-none">
                <div class="w-10 rounded-full overflow-hidden">
                    <a href="/p/{{ user.username }}">
                        <img class="w-full h-full object-cover" src="{{ user.profile.image_url }}" alt="{{ user.username }}">
                    </a>
                </div>
            </div>
            <div class="flex flex-col flex-1 min-w-0">
                <form hx-post="{{ post_url|default:'/submit-post' }}" hx-target="{{ hx_target|default:'#posts-body' }}" hx-swap="{{ hx_swap|default:'afterbegin' }}"
                    hx-on:close-modal="this.reset(); updateVisibility(this, 'Public', 'Public'); {{ modal_id }}.close()">
                    {% csrf_token %}
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex flex-col flex-1 min-w-0 gap-4 form-control">
                            <div class="font-bold form-control w-full">
                                {% render_field post_form.title placeholder="Title..." class="input input-bordered focus:outline-none" autofocus="true" %}
                            </div>
                            {% render_field post_content_form.text placeholder="Share something..." class="textarea textarea-bordered h-48 focus:outline-none text-lg resize-none" %}
                            
                            <div class="flex flex-row justify-between items-center mt-2">
                                <div class="dropdown dropdown-top">
                                    <div tabindex="0" role="button" class="btn btn-sm btn-ghost bg-base-200 gap-2 normal-case" id="{{ modal_id }}_visibility-trigger">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                        <span id="{{ modal_id }}_visibility-label">Public</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                                    </div>
                                    <ul tabindex="0" class="dropdown-content menu bg-base-200 rounded-box z-[1] w-52 p-2 shadow-lg mb-2">
                                        <li><a onclick="updateVisibility(this, 'Public', 'Public')">Public</a></li>
                                        <li><a onclick="updateVisibility(this, 'Contacts Only', 'Contacts Only')">Contacts Only</a></li>
                                    </ul>
                                    <div class="hidden">
                                        {% with visibility_input_id=modal_id|add:"_visibility-input" %}
                                            {% render_field post_form.visibility id=visibility_input_id %}
                                        {% endwith %}
                                    </div>
                                </div>
                            </div>

                            <script>
                                function updateVisibility(element, value, label) {
                                    let container = element.closest('form');
                                    if (!container) return;

                                    const input = container.querySelector('[name="visibility"]');
                                    const trigger = container.querySelector('[id$="_visibility-trigger"]');
                                    const labelSpan = trigger ? trigger.querySelector('span') : null;

                                    if (input && labelSpan) {
                                        input.value = value;
                                        labelSpan.innerText = label;
                                    }
                                    if (document.activeElement && element.tagName === 'A') {
                                        document.activeElement.blur();
                                    }
                                }
                            </script>
                        </div>
                        
                        <!-- Interests Section -->
                        <div class="form-control w-full md:w-auto">
                            <div class="w-full md:w-64 h-48 md:h-64 border border-base-content/20 rounded-lg overflow-y-auto bg-base-100 scrollbar-thin">
                                {% for category in interest_categories %}
                                <div class="mb-4">
                                    <h3 class="font-bold text-sm sticky top-0 bg-base-200 z-10 py-2 px-4 shadow-sm">{{ category.name }}</h3>
                                    <div class="flex flex-col gap-1 px-4 mt-2">
                                        {% for interest in category.interests.all %}
                                        <label class="label cursor-pointer justify-start gap-2 py-1 hover:bg-base-200 rounded-md px-1 -mx-1 transition-colors">
                                            <input type="checkbox" name="interests" value="{{ interest.id }}" class="checkbox checkbox-xs" {% if interest.id in selected_interests %}checked{% endif %} />
                                            <span class="label-text text-sm">{{ interest.name }}</span>
                                        </label>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end mt-4">
                        <button type="submit" class="btn btn-primary px-8">{{ submit_text|default:"Post" }}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

{% if auto_open %}
<script>
    document.getElementById("{{ modal_id }}").showModal();
</script>
{% endif %}

{% endwith %}
